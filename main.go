package main

import (
	_ "AIHealthServer/docs" // docs is generated by Swag CLI, you have to import it.
	"AIHealthServer/model"
	"AIHealthServer/router"
	"crypto/tls"
	"log"
	"net"

	"github.com/gin-contrib/cors"

	swaggerFiles "github.com/swaggo/files"
	ginSwagger "github.com/swaggo/gin-swagger"
	"gopkg.in/mgo.v2"
)

// @title AIHealth API
// @version 1.0
// @description This is a AIHealth server.
// @host localhost:8080
// @BasePath /
func main() {
	log.Println("AIHealth start...")
	log.Println("Connecting MongoDB")
	dialInfo := mgo.DialInfo{
		Addrs: []string{
			"cluster0-shard-00-00.xkwrz.mongodb.net:27017",
			"cluster0-shard-00-01.xkwrz.mongodb.net:27017",
			"cluster0-shard-00-02.xkwrz.mongodb.net:27017"},
		Username: "aihealth",
		Password: "YWaMxPZh7mGM5k7Q",
	}
	tlsConfig := &tls.Config{}
	dialInfo.DialServer = func(addr *mgo.ServerAddr) (net.Conn, error) {
		conn, err := tls.Dial("tcp", addr.String(), tlsConfig) // add TLS config
		return conn, err
	}
	var err error
	// model.MongoSession, err = mgo.DialWithInfo(&dialInfo)
	// model.MongoSession, err = mgo.Dial("127.0.0.1")
	model.MongoSession, err = mgo.Dial("aiwac.net:27017")

	defer model.MongoSession.Close()
	if err != nil {
		log.Println("Connect MongoDB Failed")
		log.Println(err)
	} else {
		log.Println("Connected MongoDB Success")
	}

	r := router.SetupRouter()
	r.Use(cors.Default())
	r.GET("/api/*any", ginSwagger.WrapHandler(swaggerFiles.Handler))
	r.Run(":8080")
}
